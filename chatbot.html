<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç­‹ãƒˆãƒ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ - sumida</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #222;
            background: #ffffff;
            min-height: 100vh;
        }

        .app {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-bottom: 24px;
            border-bottom: 1px solid #e8e8e8;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 0.08em;
            color: #333;
            text-transform: uppercase;
        }

        .back-link {
            color: #666;
            text-decoration: none;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 999px;
            background: #f5f5f5;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            background: #ebebeb;
            color: #333;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #e8e8e8;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            min-height: 500px;
        }

        .chat-header {
            background: #667eea;
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-header-icon {
            font-size: 1.5rem;
        }

        .chat-header-text h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chat-header-text p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .message.bot {
            background: white;
            border: 1px solid #e8e8e8;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.user {
            background: #667eea;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.bot .sender {
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .message.loading {
            background: white;
            border: 1px solid #e8e8e8;
        }

        .loading-dots {
            display: flex;
            gap: 4px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .chat-input-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #e8e8e8;
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .chat-input::placeholder {
            color: #aaa;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: #5569d6;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .quick-questions {
            padding: 12px 20px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            font-size: 0.85rem;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .api-key-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .api-key-notice h3 {
            color: #856404;
            margin-bottom: 8px;
        }

        .api-key-notice input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .api-key-notice button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .api-key-notice.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 160px);
            }

            .message {
                max-width: 90%;
            }

            .quick-questions {
                display: none;
            }
        }
    </style>
</head>
<body>
    <main class="app">
        <header class="app-header">
            <div class="logo">sumida</div>
            <a href="index.html" class="back-link">â† è¨ºæ–­ã«æˆ»ã‚‹</a>
        </header>

        <div class="api-key-notice" id="apiKeyNotice">
            <h3>Gemini APIã‚­ãƒ¼ã‚’è¨­å®š</h3>
            <p>ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™ã€‚<br>
            <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>ã§ç„¡æ–™ã§å–å¾—ã§ãã¾ã™ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›..." />
            <button onclick="saveApiKey()">ä¿å­˜ã—ã¦é–‹å§‹</button>
        </div>

        <div class="chat-container" id="chatContainer" style="display: none;">
            <div class="chat-header">
                <span class="chat-header-icon">ğŸ’ª</span>
                <div class="chat-header-text">
                    <h2>ç­‹ãƒˆãƒ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</h2>
                    <p>ç¨®ç›®ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„</p>
                </div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="sender">ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</div>
                    ã“ã‚“ã«ã¡ã¯ï¼ç­‹ãƒˆãƒ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚<br><br>
                    ç¨®ç›®ã®é¸ã³æ–¹ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ„ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®çµ„ã¿æ–¹ãªã©ã€ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚<br><br>
                    ä¾‹ãˆã°ã€Œåˆå¿ƒè€…ã«ãŠã™ã™ã‚ã®èƒ¸ãƒˆãƒ¬ã¯ï¼Ÿã€ã€Œãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ã®ã‚³ãƒ„ã‚’æ•™ãˆã¦ã€ãªã©ã€æ°—è»½ã«ã©ã†ãï¼
                </div>
            </div>

            <div class="quick-questions">
                <button class="quick-btn" onclick="sendQuickQuestion(this)">åˆå¿ƒè€…ã«ãŠã™ã™ã‚ã®ç¨®ç›®ã¯ï¼Ÿ</button>
                <button class="quick-btn" onclick="sendQuickQuestion(this)">è‡ªå®…ã§ã§ãã‚‹ç­‹ãƒˆãƒ¬ã¯ï¼Ÿ</button>
                <button class="quick-btn" onclick="sendQuickQuestion(this)">ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ã®ã‚³ãƒ„</button>
            </div>

            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput"
                       placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                       onkeypress="handleKeyPress(event)" />
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    â¤
                </button>
            </div>
        </div>
    </main>

    <script>
        // ç¨®ç›®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦ä½¿ç”¨ï¼‰
        const exerciseContext = `
ã‚ãªãŸã¯ç­‹ãƒˆãƒ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ç¨®ç›®ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€ç¨®ç›®ä¸€è¦§ã€‘ï¼ˆé›£æ˜“åº¦1-5ã€ç­‹è‚¥å¤§åŠ¹æœ1-5ï¼‰

â–  èƒ¸
- ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦3, ç­‹è‚¥å¤§5, ã‚¸ãƒ å°‚ç”¨ã€‚è‚©ç”²éª¨ã‚’å¯„ã›ã¦èƒ¸ã‚’å¼µã‚‹ã€‚è‚˜ã‚’90åº¦ä»¥ä¸Šé–‹ãã¨è‚©ã‚’ç—›ã‚ã‚„ã™ã„ã€‚
- ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦2, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚å¯å‹•åŸŸãŒåºƒã„ã€‚å·¦å³ã®ãƒãƒ©ãƒ³ã‚¹ã«æ³¨æ„ã€‚
- ãƒã‚§ã‚¹ãƒˆãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦1, ç­‹è‚¥å¤§3, ã‚¸ãƒ å°‚ç”¨ã€‚ãƒã‚·ãƒ³ã§å®‰å…¨ã€‚åˆå¿ƒè€…ã«ãŠã™ã™ã‚ã€‚
- ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦3, ç­‹è‚¥å¤§4, ã‚¸ãƒ å°‚ç”¨ã€‚å¤§èƒ¸ç­‹ä¸Šéƒ¨ã‚’é›ãˆã‚‹ã€‚è§’åº¦ã¯30-45åº¦ã€‚
- ãƒ—ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—: é›£æ˜“åº¦2, ç­‹è‚¥å¤§2, è‡ªå®…OKã€‚æ‰‹å¹…ã¯è‚©å¹…ã‚ˆã‚Šå°‘ã—åºƒã‚ã€‚è…°ãŒè½ã¡ãªã„ã‚ˆã†æ³¨æ„ã€‚

â–  èƒŒä¸­
- ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³: é›£æ˜“åº¦2, ç­‹è‚¥å¤§4, ã‚¸ãƒ å°‚ç”¨ã€‚èƒ¸ã‚’å¼µã‚Šã€è‚˜ã‚’è„‡è…¹ã«å‘ã‹ã£ã¦å¼•ãã€‚
- ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ãƒ¼: é›£æ˜“åº¦2, ç­‹è‚¥å¤§4, ã‚¸ãƒ å°‚ç”¨ã€‚è‚©ç”²éª¨ã‚’å¯„ã›ã‚‹æ„è­˜ã€‚ä½“ã‚’å¾Œã‚ã«å€’ã—ã™ããªã„ã€‚
- ãƒ¯ãƒ³ãƒãƒ³ãƒ‰ãƒ­ãƒ¼: é›£æ˜“åº¦2, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚ç‰‡æ‰‹ãšã¤è¡Œã†ã€‚ä½“ã‚’ã²ã­ã‚‰ãªã„ã€‚

â–  è‚©
- ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦3, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚è…°ã‚’åã‚‰ã›ã™ããªã„ã€‚é¦–ã‚’ã™ãã‚ãªã„ã€‚

â–  è…•
- ã‚¢ãƒ¼ãƒ ã‚«ãƒ¼ãƒ«: é›£æ˜“åº¦1, ç­‹è‚¥å¤§3, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚è‚˜ã®ä½ç½®ã‚’å›ºå®šã€‚åå‹•ã‚’ä½¿ã‚ãªã„ã€‚
- ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³: é›£æ˜“åº¦2, ç­‹è‚¥å¤§3, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚è‚˜ã‚’è€³ã®æ¨ªã«å›ºå®šã€‚

â–  è„š
- ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ: é›£æ˜“åº¦4, ç­‹è‚¥å¤§5, ã‚¸ãƒ å°‚ç”¨ã€‚è†ã¨ã¤ã¾å…ˆã®å‘ãã‚’æƒãˆã‚‹ã€‚è…°ã‚’ä¸¸ã‚ãªã„ã€‚
- ãƒ–ãƒ«ã‚¬ãƒªã‚¢ãƒ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ: é›£æ˜“åº¦3, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚ç‰‡è¶³ãšã¤ã€‚ãƒãƒ©ãƒ³ã‚¹æ³¨æ„ã€‚
- ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹: é›£æ˜“åº¦1, ç­‹è‚¥å¤§4, ã‚¸ãƒ å°‚ç”¨ã€‚è†ã‚’å®Œå…¨ã«ä¼¸ã°ã•ãªã„ã€‚åˆå¿ƒè€…ã«ãŠã™ã™ã‚ã€‚
- RDL: é›£æ˜“åº¦4, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚èƒŒä¸­ã‚’çœŸã£ç›´ãã«ã€‚ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ã‚’æ„è­˜ã€‚
- ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ: é›£æ˜“åº¦5, ç­‹è‚¥å¤§5, ã‚¸ãƒ å°‚ç”¨ã€‚çµ¶å¯¾ã«èƒŒä¸­ã‚’ä¸¸ã‚ãªã„ã€‚ä¸Šç´šè€…å‘ã‘ã€‚
- ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«: é›£æ˜“åº¦1, ç­‹è‚¥å¤§3, ã‚¸ãƒ å°‚ç”¨ã€‚ãƒãƒ ã‚¹ãƒˆãƒªãƒ³ã‚°ã‚¹ã‚’é›ãˆã‚‹ã€‚
- ãƒ’ãƒƒãƒ—ã‚¹ãƒ©ã‚¹ãƒˆ: é›£æ˜“åº¦2, ç­‹è‚¥å¤§4, ã‚¸ãƒ ãƒ»è‡ªå®…ã€‚ãŠå°»ã‚’æ„è­˜ã—ã¦æŒã¡ä¸Šã’ã‚‹ã€‚

â–  è…¹
- ãƒ—ãƒ©ãƒ³ã‚¯: é›£æ˜“åº¦1, ç­‹è‚¥å¤§2, è‡ªå®…OKã€‚é ­ã‹ã‚‰ã‹ã‹ã¨ã¾ã§ä¸€ç›´ç·šã€‚
- ã‚µã‚¤ãƒ‰ãƒ—ãƒ©ãƒ³ã‚¯: é›£æ˜“åº¦2, ç­‹è‚¥å¤§2, è‡ªå®…OKã€‚è…¹æ–œç­‹ã‚’é›ãˆã‚‹ã€‚
- ã‚¯ãƒ©ãƒ³ãƒ: é›£æ˜“åº¦1, ç­‹è‚¥å¤§2, è‡ªå®…OKã€‚é¦–ã‚’å¼•ã£å¼µã‚‰ãªã„ã€‚
- ãƒ¬ãƒƒã‚°ãƒ¬ã‚¤ã‚º: é›£æ˜“åº¦2, ç­‹è‚¥å¤§3, è‡ªå®…OKã€‚è…°ã‚’åºŠã«ã¤ã‘ãŸã¾ã¾ã€‚
- ãƒ‡ãƒƒãƒ‰ãƒã‚°: é›£æ˜“åº¦2, ç­‹è‚¥å¤§2, è‡ªå®…OKã€‚ä½“å¹¹å®‰å®šæ€§ã‚’é«˜ã‚ã‚‹ã€‚

ã€å›ç­”ã®ãƒ«ãƒ¼ãƒ«ã€‘
- åˆå¿ƒè€…ã«ã¯é›£æ˜“åº¦1-2ã®ç¨®ç›®ã‚’ãŠã™ã™ã‚
- è‡ªå®…ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¯ã€Œè‡ªå®…OKã€ã®ç¨®ç›®ã‚’ææ¡ˆ
- å…·ä½“çš„ãªãƒ•ã‚©ãƒ¼ãƒ ã®ã‚³ãƒ„ã‚’å«ã‚ã‚‹
- æ€ªæˆ‘é˜²æ­¢ã®æ³¨æ„ç‚¹ã‚‚ä¼ãˆã‚‹
- ç°¡æ½”ã«ã€ã§ã‚‚è¦ªåˆ‡ã«å›ç­”ã™ã‚‹
`;

        let apiKey = localStorage.getItem('gemini_api_key');
        let conversationHistory = [];
        // ä¸€èˆ¬çš„ã«å‹•ä½œã™ã‚‹ãƒ¢ãƒ‡ãƒ«åã®ãƒªã‚¹ãƒˆï¼ˆå„ªå…ˆé †ä½é †ï¼‰
        const modelNames = [
            'gemini-1.5-flash-001',
            'gemini-1.5-flash-latest',
            'gemini-1.5-flash',
            'gemini-1.5-pro',
            'gemini-pro'
        ];
        let modelName = modelNames[0]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æœ€åˆã®ãƒ¢ãƒ‡ãƒ«

        // åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªã—ã¦ã€å‹•ä½œã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¤ã‘ã‚‹
        async function checkAvailableModels() {
            if (!apiKey) return;
            
            try {
                // ã¾ãšãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—
                const listResponse = await fetch(
                    `https://generativelanguage.googleapis.com/v1/models?key=${apiKey}`
                );
                const listData = await listResponse.json();
                
                if (listData.models) {
                    // åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«åã‚’æŠ½å‡º
                    const availableModels = listData.models
                        .map(m => m.name ? m.name.replace('models/', '') : null)
                        .filter(m => m && m.includes('gemini'));
                    
                    // å„ªå…ˆé †ä½ã«å¾“ã£ã¦åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™
                    for (const preferredModel of modelNames) {
                        if (availableModels.some(m => m === preferredModel || m.includes(preferredModel))) {
                            modelName = preferredModel;
                            console.log('ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«:', modelName);
                            return;
                        }
                    }
                    
                    // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€åˆã®geminiãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
                    if (availableModels.length > 0) {
                        modelName = availableModels[0];
                        console.log('ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆè‡ªå‹•é¸æŠï¼‰:', modelName);
                    }
                }
            } catch (error) {
                console.error('ãƒ¢ãƒ‡ãƒ«ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«åã‚’ä½¿ç”¨
            }
        }

        // åˆæœŸåŒ–
        async function init() {
            if (apiKey) {
                document.getElementById('apiKeyNotice').classList.add('hidden');
                document.getElementById('chatContainer').style.display = 'flex';
                await checkAvailableModels();
            }
        }

        async function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('gemini_api_key', key);
                document.getElementById('apiKeyNotice').classList.add('hidden');
                document.getElementById('chatContainer').style.display = 'flex';
                await checkAvailableModels();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendQuickQuestion(btn) {
            document.getElementById('chatInput').value = btn.textContent;
            sendMessage();
        }

        function addMessage(content, isUser) {
            const messagesEl = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isUser ? 'user' : 'bot'}`;

            if (!isUser) {
                messageEl.innerHTML = `<div class="sender">ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</div>${content.replace(/\n/g, '<br>')}`;
            } else {
                messageEl.textContent = content;
            }

            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return messageEl;
        }

        function addLoadingMessage() {
            const messagesEl = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message bot loading';
            messageEl.id = 'loadingMessage';
            messageEl.innerHTML = `
                <div class="sender">ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</div>
                <div class="loading-dots">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message || !apiKey) return;

            // UIæ›´æ–°
            input.value = '';
            sendBtn.disabled = true;
            addMessage(message, true);
            addLoadingMessage();

            // ä¼šè©±å±¥æ­´ã«è¿½åŠ 
            conversationHistory.push({ role: 'user', parts: [{ text: message }] });

            try {
                // ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã«å‚™ãˆã¦ã€è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«åã‚’é †ç•ªã«è©¦ã™
                let lastError = null;
                let success = false;

                for (const testModelName of modelNames) {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1/models/${testModelName}:generateContent?key=${apiKey}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [
                                        { role: 'user', parts: [{ text: exerciseContext }] },
                                        { role: 'model', parts: [{ text: 'ã¯ã„ã€ç­‹ãƒˆãƒ¬ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã¨ã—ã¦å›ç­”ã—ã¾ã™ã€‚' }] },
                                        ...conversationHistory
                                    ],
                                    generationConfig: {
                                        temperature: 0.7,
                                        maxOutputTokens: 1024,
                                    }
                                })
                            }
                        );

                        const data = await response.json();
                        
                        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
                            // æˆåŠŸã—ãŸãƒ¢ãƒ‡ãƒ«åã‚’ä¿å­˜
                            modelName = testModelName;
                            const reply = data.candidates[0].content.parts[0].text;
                            removeLoadingMessage();
                            addMessage(reply, false);
                            conversationHistory.push({ role: 'model', parts: [{ text: reply }] });
                            success = true;
                            break;
                        } else if (data.error) {
                            lastError = data.error;
                            // æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™
                            continue;
                        }
                    } catch (error) {
                        lastError = { message: error.message };
                        continue;
                    }
                }

                if (!success) {
                    removeLoadingMessage();
                    let errorMsg = `ã‚¨ãƒ©ãƒ¼: ${lastError ? lastError.message : 'ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}`;
                    errorMsg += '\n\nåˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªä¸­...';
                    addMessage(errorMsg, false);
                    
                    // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦è¡¨ç¤º
                    try {
                        await checkAvailableModels();
                        addMessage(`ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«è¨­å®š: ${modelName}\n\nåˆ¥ã®ãƒ¢ãƒ‡ãƒ«åã‚’è©¦ã™ã‹ã€APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, false);
                    } catch (e) {
                        addMessage('ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', false);
                    }
                }
            } catch (error) {
                removeLoadingMessage();
                addMessage(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, false);
            }

            sendBtn.disabled = false;
            input.focus();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        init();
    </script>
</body>
</html>
