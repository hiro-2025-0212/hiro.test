# チャットボット設計書

## 概要

筋トレ診断サイトにAIチャットボット「筋トレアドバイザー」を導入し、ユーザーが種目やメニューについて自由に質問できる機能を提供する。

---

## 導入目的

| 目的 | 詳細 |
|------|------|
| **ユーザー体験向上** | 診断結果だけでなく、個別の疑問に対応 |
| **種目理解の促進** | フォームのコツや注意点を会話形式で学べる |
| **サイト滞在時間増加** | インタラクティブな機能で継続利用を促進 |

---

## システム構成

### アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                        ブラウザ                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   chatbot.html                       │   │
│  │  ┌───────────┐    ┌───────────┐    ┌────────────┐  │   │
│  │  │ チャットUI │ → │ JavaScript │ → │ fetch API  │  │   │
│  │  └───────────┘    └───────────┘    └────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                  Google Gemini API                          │
│                 (gemini-1.5-flash)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  システムプロンプト（種目データ）                      │   │
│  │         +                                            │   │
│  │  ユーザーの質問                                       │   │
│  │         ↓                                            │   │
│  │  AI生成の回答                                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 処理フロー

```
1. ユーザーがchatbot.htmlにアクセス
         ↓
2. APIキー確認（LocalStorageから取得）
   - なければ入力画面を表示
   - あればチャット画面を表示
         ↓
3. ユーザーが質問を入力
         ↓
4. JavaScriptでリクエスト構築
   - システムプロンプト（種目データ）
   - 会話履歴
   - 新しい質問
         ↓
5. Gemini APIにPOSTリクエスト送信
         ↓
6. レスポンスを受信・パース
         ↓
7. 回答をチャット画面に表示
         ↓
8. 会話履歴に追加（次の質問で参照）
```

---

## 使用技術

### AI モデル

| 項目 | 内容 |
|------|------|
| **サービス** | Google Generative AI |
| **モデル** | gemini-1.5-flash |
| **選定理由** | 無料枠が大きい、高速、日本語対応良好 |

### 無料枠

| 制限 | 値 |
|------|-----|
| リクエスト/分 | 15 |
| リクエスト/日 | 1,500 |
| トークン/分 | 100万 |
| 料金 | $0（無料枠内） |

### フロントエンド

| 技術 | 用途 |
|------|------|
| HTML5 | ページ構造 |
| CSS3 | スタイリング（チャットUI） |
| JavaScript (ES6+) | API通信、DOM操作 |
| Fetch API | HTTPリクエスト |
| LocalStorage | APIキー保存 |

---

## APIリクエスト仕様

### エンドポイント

```
POST https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key={API_KEY}
```

### リクエストボディ

```json
{
  "contents": [
    {
      "role": "user",
      "parts": [{ "text": "{システムプロンプト}" }]
    },
    {
      "role": "model",
      "parts": [{ "text": "はい、筋トレアドバイザーとして回答します。" }]
    },
    {
      "role": "user",
      "parts": [{ "text": "{ユーザーの質問}" }]
    }
  ],
  "generationConfig": {
    "temperature": 0.7,
    "maxOutputTokens": 1024
  }
}
```

### レスポンス

```json
{
  "candidates": [
    {
      "content": {
        "parts": [
          { "text": "AIの回答テキスト" }
        ],
        "role": "model"
      }
    }
  ]
}
```

---

## システムプロンプト設計

### 目的
AIに種目データを理解させ、それに基づいた正確な回答を生成させる。

### 構成

```
あなたは筋トレアドバイザーです。以下の種目データを基に回答してください。

【種目一覧】（難易度1-5、筋肥大効果1-5）

■ 胸
- ベンチプレス: 難易度3, 筋肥大5, ジム専用。[フォームのコツ]。[注意点]。
- ダンベルプレス: 難易度2, 筋肥大4, ジム・自宅。...
...

【回答のルール】
- 初心者には難易度1-2の種目をおすすめ
- 自宅トレーニングには「自宅OK」の種目を提案
- 具体的なフォームのコツを含める
- 怪我防止の注意点も伝える
- 簡潔に、でも親切に回答する
```

### 含まれるデータ

| データ | 用途 |
|--------|------|
| 種目名 | 回答で種目を特定 |
| 難易度 | 初心者向け提案の判断 |
| 筋肥大効果 | 効果的な種目の提案 |
| 対応環境 | ジム/自宅の判断 |
| フォームのコツ | 具体的なアドバイス |
| 注意点 | 怪我防止の案内 |

---

## UI設計

### 画面構成

```
┌─────────────────────────────────────┐
│  SUMIDA          [← 診断に戻る]     │  ← ヘッダー
├─────────────────────────────────────┤
│  💪 筋トレアドバイザー               │  ← チャットヘッダー
│     種目やメニューについて何でも...   │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────┐            │
│  │ Bot: こんにちは！    │            │  ← メッセージエリア
│  └─────────────────────┘            │
│                                     │
│            ┌─────────────────────┐  │
│            │ User: 初心者向けは？ │  │
│            └─────────────────────┘  │
│                                     │
│  ┌─────────────────────┐            │
│  │ Bot: 初心者には...   │            │
│  └─────────────────────┘            │
│                                     │
├─────────────────────────────────────┤
│ [初心者におすすめ] [自宅トレ] [コツ] │  ← クイック質問
├─────────────────────────────────────┤
│ [メッセージを入力...          ] [➤] │  ← 入力エリア
└─────────────────────────────────────┘
```

### UIコンポーネント

| コンポーネント | 説明 |
|---------------|------|
| **チャットヘッダー** | タイトルと説明 |
| **メッセージエリア** | 会話履歴をスクロール表示 |
| **ボットメッセージ** | 左寄せ、白背景 |
| **ユーザーメッセージ** | 右寄せ、青背景 |
| **ローディング** | 3点ドットのアニメーション |
| **クイック質問** | よくある質問をワンタップで |
| **入力エリア** | テキスト入力＋送信ボタン |

### アクセス方法

1. **フローティングボタン** - 画面右下の💬ボタン
2. **直接URL** - chatbot.html

---

## データフロー

### 会話履歴の管理

```javascript
let conversationHistory = [];

// ユーザー発言を追加
conversationHistory.push({
  role: 'user',
  parts: [{ text: userMessage }]
});

// AI応答を追加
conversationHistory.push({
  role: 'model',
  parts: [{ text: aiResponse }]
});
```

### APIキーの管理

```javascript
// 保存
localStorage.setItem('gemini_api_key', apiKey);

// 取得
const apiKey = localStorage.getItem('gemini_api_key');
```

---

## セキュリティ考慮

### 現在の構成（テスト/個人利用向け）

| 項目 | 状態 | リスク |
|------|------|--------|
| APIキー | LocalStorageに保存 | ブラウザからアクセス可能 |
| 通信 | HTTPS | 安全 |
| 認証 | なし | 誰でもアクセス可能 |

### 本番環境向け推奨構成

```
ユーザー → フロントエンド → バックエンドサーバー → Gemini API
                              （APIキーを隠蔽）
```

| 改善点 | 方法 |
|--------|------|
| APIキー隠蔽 | サーバーサイドで管理 |
| レート制限 | ユーザーごとの制限を実装 |
| 認証 | ログイン機能を追加 |

---

## 想定される質問と回答例

### 例1: 初心者向け

```
User: 初心者におすすめの胸トレは？

Bot: 初心者には以下の種目がおすすめです：

1. チェストプレス（難易度1）
   - マシンで軌道が安定
   - 重量調整が簡単

2. プッシュアップ（難易度2）
   - 自宅でもできる
   - 手幅は肩幅より少し広め

まずはチェストプレスから始めて、
フォームに慣れてからベンチプレスに
挑戦するのがおすすめです！
```

### 例2: フォームの質問

```
User: ベンチプレスのコツを教えて

Bot: ベンチプレスのポイントです：

【意識すること】
- 肩甲骨を寄せて胸を張る
- バーは乳首ライン付近に下ろす
- 足でしっかり床を踏んで安定させる

【注意点】
- 肘を90度以上開くと肩を痛めやすい
- お尻をベンチから浮かせない
- 手首は真っ直ぐに保つ

最初は軽い重量でフォームを
確認しながら行いましょう！
```

---

## 今後の拡張案

| 機能 | 説明 | 優先度 |
|------|------|--------|
| 音声入力 | マイクで質問 | 低 |
| 画像認識 | フォーム写真を分析 | 中 |
| パーソナライズ | 診断結果を踏まえた回答 | 高 |
| 多言語対応 | 英語等での回答 | 低 |
| オフライン対応 | よくある質問はローカルで | 中 |

---

## ファイル構成

```
/
├── chatbot.html        # チャットボットページ
├── index.html          # フローティングボタンを追加済み
└── doc/
    └── チャットボット設計書.md  # 本ファイル
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-XX | 初期版作成（Gemini API連携） |
